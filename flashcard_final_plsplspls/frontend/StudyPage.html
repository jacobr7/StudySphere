<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Mode</title>

    <!-- Firebase v8 for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css"> <!-- Ensure your updated CSS file is linked here -->

    <style>
        
    </style>
</head>
<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #141B4D;">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                
                <!-- StudySphere brand text -->
                <a class="navbar-brand text-white" href="#">StudySphere</a>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- add links to each page here/ create pages here  --------------------------------------------->
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Forum</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Notes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../flashcard_final_plsplspls/frontend/FlashcardDecks.html">Flashcard</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
                
            </div>
        </div>
    </nav>

    <!-- Adjusted HTML Structure -->
    <div class="container mt-4">
        <h2 class="study-title">Study Mode</h2>
        <div id="study-flashcard" class="study-flashcard">
            <div id="question-area" class="flashcard-content question-area">Loading...</div>
            <div id="answer-area" class="flashcard-content answer-area">Loading...</div>
            <button class="study-reveal-btn" id="study-reveal-btn" onclick="revealAnswer()">Reveal Answer</button>
        </div>
    </div>

    <div class="study-controls">
        <button class="study-back-btn" onclick="goBack()">Back</button>
        <button class="study-next-btn" onclick="loadNextCard()">Next Card</button>
    </div>

    <script>
        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyCSTt_BtYR07qzKHm9pBgJ93RARJjt-HNA",
            authDomain: "studysphere-8f8ae.firebaseapp.com",
            projectId: "studysphere-8f8ae",
            storageBucket: "studysphere-8f8ae.appspot.com",
            messagingSenderId: "1043087075619",
            appId: "1:1043087075619:web:10ddd930f52125a0960496",
            measurementId: "G-Q4FTB6VJEC"
        });

        const db = firebase.firestore();

        // Use onAuthStateChanged to reliably get auth status
        firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("User is logged in:", user);
                    // User is authenticated, allow access to the page
                } else {
                    console.log("No user is logged in, redirecting to login page");
                    sessionStorage.setItem("redirectAfterLogin", window.location.href);
                    window.location.href = "../../login_page/frontend/loginpage.html"; 
                }
            });

        firebase.auth().onAuthStateChanged(async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            const deckId = urlParams.get('deckId');

            if (user && deckId) {
                loadFlashcards(user.uid, deckId);
            } else {
                document.getElementById("study-flashcard").innerHTML = "<p>Error loading flashcards. Please try again.</p>";
            }
        });

        let flashcards = [];
        let shownCards = new Set();

        async function loadFlashcards(userId, deckId) {
            const container = document.getElementById("study-flashcard");

            try {
                const snapshot = await db.collection("users").doc(userId).collection("decks").doc(deckId).collection("cards").get();

                if (snapshot.empty) {
                    container.innerHTML = "<p>No flashcards available.</p>";
                    return;
                }

                flashcards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadNextCard();

            } catch (error) {
                console.error("Error loading flashcards:", error);
                container.innerHTML = "<p>Error loading flashcards. Please try again.</p>";
            }
        }

        function loadNextCard() {
            if (flashcards.length === 0) {
                document.getElementById("study-flashcard").innerHTML = "<p>No flashcards available.</p>";
                return;
            }

            if (shownCards.size === flashcards.length) {
                shownCards.clear();
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * flashcards.length);
            } while (shownCards.has(randomIndex));

            shownCards.add(randomIndex);

            const cardData = flashcards[randomIndex];
            const questionArea = document.getElementById("question-area");
            const answerArea = document.getElementById("answer-area");

            questionArea.innerText = cardData.f1;
            answerArea.innerText = cardData.f2;
            answerArea.style.display = "none";
            document.getElementById("study-reveal-btn").style.display = "inline-block";
        }

        function revealAnswer() {
            document.getElementById("answer-area").style.display = "block";
            document.getElementById("study-reveal-btn").style.display = "none";
        }

        function goBack() {
            window.history.back();
        }
    </script>

    <!-- Bootstrap JS for modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
